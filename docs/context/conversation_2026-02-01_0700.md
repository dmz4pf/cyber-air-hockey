# Context Snapshot - Air Hockey Puck Movement Bug
**Date:** 2026-02-01 07:00
**Context Usage:** 460%

## Current Issue
Puck starts moving on its own after being reset to center following a goal. It should stay still until hit by a paddle.

## Hypothesis
The interpolation system is using old velocity values to extrapolate the puck position even after reset. When puck resets, the velocity should also be zero, but extrapolation uses the last known velocity.

## Fixes Applied This Session
1. **Jump detection in interpolation** - Clear buffer when position jumps >100px
2. **ESC button repositioned** - Moved to top right with absolute positioning
3. **Verified reconnection logic** - Robust with 5 attempts, exponential backoff

## Previous Session Fixes
1. Winner display bug - Changed modals to use `multiplayerEngine.playerNumber`
2. Puck interpolation - Added `useInterpolation` for smoother puck movement
3. Multiplayer detection - Using `gameModeType` for reliable detection
4. AI physics disabled in multiplayer - Server is authoritative

## Files Modified
- `src/hooks/useInterpolation.ts` - Added jump detection (lines 44-76)
- `src/app/(cyber)/game/page.tsx` - ESC button to top right (lines 398-429)
- `src/hooks/useMultiplayerGameEngine.ts` - Puck interpolation

## Root Cause Investigation Needed
Check `src/hooks/useInterpolation.ts` - the extrapolation logic at lines 122-139:
- When puck resets, new snapshot has vx=0, vy=0
- But extrapolation uses `latest.vx` and `latest.vy`
- If buffer was just cleared and only has one snapshot, it returns that snapshot directly
- Issue: The extrapolation case (lines 122-139) still uses old velocity after buffer clear?

## Server Physics Reset
Location: `server/src/physics/engine.ts` - `resetPuck()` method
- Should reset position to center AND velocity to zero

## Next Steps
1. Verify server sends velocity=0 when puck resets
2. Check if interpolation extrapolation is using stale velocity
3. May need to store velocity in snapshot and use 0 for extrapolation after reset
