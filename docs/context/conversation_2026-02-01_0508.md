# Context Snapshot - Air Hockey Multiplayer Debug
**Date:** 2026-02-01 05:08
**Context Usage:** 128%

## Current Task
Fixed multiplayer synchronization bugs where:
1. Creator saw static opponent (opponent paddle didn't move)
2. Second user played against AI instead of real opponent, scoreboard not counting

## Key Decisions Made
- **Use `gameModeType` OR `mode`**: More reliable detection of multiplayer mode since `gameModeType` is explicitly set in store actions
- **Disable AI engine in multiplayer**: The AI physics loop was running in parallel with server state, causing conflicts
- **Add null check for playerNumber**: Prevents silent failures when paddle moves are attempted before server assigns player number

## Fixes Implemented

### 1. `src/app/(cyber)/game/page.tsx`
- Added `gameModeType` selector from store
- Changed `isMultiplayerGame` to use both `gameModeType` and `mode`:
  ```typescript
  const isMultiplayerGame = (gameModeType === 'multiplayer' || mode === 'multiplayer') && multiplayerGameInfo?.gameId;
  ```
- Added debug logging for engine selection

### 2. `src/hooks/useMultiplayerGameEngine.ts`
- Added explicit null check for `playerNumber` in `movePaddle`:
  ```typescript
  if (!playerNumber) {
    console.log('[MultiplayerEngine] Cannot move paddle: playerNumber not yet assigned');
    return;
  }
  ```

### 3. `src/hooks/useGameEngine.ts`
- Added `mode` and `gameModeType` selectors
- Added `isMultiplayer` flag
- Skipped physics loop, goal handling, and puck reset in multiplayer mode:
  ```typescript
  if (isMultiplayer) return; // Server is authoritative in multiplayer
  ```

## Implementation State
- [x] Identified root causes through code analysis
- [x] Fixed isMultiplayerGame detection (page.tsx)
- [x] Fixed playerNumber null check (useMultiplayerGameEngine.ts)
- [x] Disabled AI engine in multiplayer mode (useGameEngine.ts)
- [x] Added debug logging
- [ ] User testing to verify fixes

## Important Context
- Architecture: Server-authoritative multiplayer with WebSocket
- AI engine and multiplayer engine are both initialized but only one should be active
- `GameReadyScreen` manages WebSocket during 'waiting'/'ready' states
- `useMultiplayerGameEngine` takes over during 'playing' state
- Context (`MultiplayerContext`) persists connection state across screen transitions

## Files Modified This Session
- `src/app/(cyber)/game/page.tsx` - Added gameModeType, improved isMultiplayerGame check, added debug logs
- `src/hooks/useMultiplayerGameEngine.ts` - Added playerNumber null check with logging
- `src/hooks/useGameEngine.ts` - Disabled physics/goals in multiplayer mode

## Next Steps
1. Start dev server and test multiplayer flow
2. Verify both players see real-time opponent movement
3. Verify scoreboard updates from server state
4. Check browser console for debug logs to confirm correct engine selection
